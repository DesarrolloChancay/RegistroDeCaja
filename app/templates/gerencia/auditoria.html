<!-- Archivo: app/templates/gerencia/auditoria.html -->

{% if current_user.is_authenticated %}
  {% extends "base.html" %} {% block title %}Gestión de Caja - {{ titulo }}{% endblock %}

  {% block content %}
  <header
    class="bg-gradient-to-r from-blue-700 to-blue-500 text-white py-4 shadow-md sticky top-0 rounded-xl"
  >
    <div class="container mx-auto flex justify-between items-center px-4">
      <h1 class="text-xl font-bold">Gestión de Caja | {{ Nombreusuario }}</h1>
      <nav class="space-x-4">
        <a
          href="/auditoria"
          class="bg-white text-blue-700 font-semibold px-4 py-2 rounded shadow"
          >Auditoría de {{ titulo }}</a
        >
        {% if sessionname == 'admin' %}
        <a href="#" class="hover:underline">Mantenimiento</a>
        {% endif %}
        <a
          href="{{ url_for('auth.logout') }}"
          class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1 transition"
        >
          <img
            src="/static/img/logout.svg"
            alt="Your Company"
            class="w-5 h-5"
          />
        </a>
      </nav>
    </div>
  </header>
  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-semibold text-center mb-6">Gestión de Caja - {{ titulo }}</h2>

    {% if sessionname == 'admin' or sessionname == 'verificador' %}
    <!-- Filtro de Fecha y Botón -->
    <div
      class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6"
    >
        <label class="block w-full md:w-auto">
          <span class="text-gray-700"
            >Seleccionar Fecha para Exportar (Registro Sistema):</span
          >
          <span class="text-gray-700">Nombre de usuario: {{ Nombreusuario }}</span>
          <input
            type="date"
            id="fecha_exportar"
            class="mt-1 block w-full md:w-auto border border-gray-300 rounded px-3 py-2"
          />
        </label>
        <button
          id="btn-exportar"
          class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-6 py-2 rounded font-semibold shadow hover:opacity-90"
        >
          Exportar Datos
        </button>
      </div>
    {% endif %}

    <!-- Tabla Principal -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left border-t">
        <thead class="bg-gray-100 text-gray-700 uppercase">
          <tr>
            <th class="px-4 py-3">Fecha Registro Sistema</th>
            <th class="px-4 py-3">Transacción</th>
            <th class="px-4 py-3">Responsable</th>
            <th class="px-4 py-3">Empresa</th>
            <th class="px-4 py-3">Banco</th>
            <th class="px-4 py-3">Monto</th>
            <th class="px-4 py-3">Detalle</th>
            <th class="px-4 py-3">Fecha Voucher Confirmación Redes</th>
            <th class="px-4 py-3">Confirmación Redes</th>
            {% if sessionname == 'admin' or sessionname == 'verificador' %}
              <th class="px-4 py-3">Fecha Ingreso Dinero</th>
              <th class="px-4 py-3">Confirmar Pago Gerencia</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
          {% set color = "green" if r.confirmado_redes == 1 and r.confirmado == 1 else "yellow" %}
          <tr class="bg-white border-b">
            <td class="px-4 py-2">
              {{ r.fecha_registro_pago.strftime('%d-%m-%Y') if
              r.fecha_registro_pago else 'N/A' }}
            </td>
            <td class="px-4 py-2">{{ r.recibo }}</td>
            <td class="px-4 py-2">{{ r.nombre_usuario }}</td>
            <td class="px-4 py-2">{{ r.empresa_nombre }}</td>
            <td class="px-4 py-2">{{ r.entidad_banco_nombre }}</td>
            <td class="px-4 py-2">{{ r.monto }}</td>
            <td class="px-4 py-2">{{ r.detalle }}</td>
            <td class="px-4 py-2">
              {% if r.fecha_comprobante %}
              <span
                class="inline-flex items-center gap-2 px-3 py-1 bg-{{ color }}-200 text-{{ color }}-800 rounded-lg shadow-sm font-bold"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                {{ r.fecha_comprobante.strftime('%d-%m-%Y') }}
              </span>
              {% else %}
              <input
                type="date"
                class="border border-gray-300 rounded px-3 py-2"
                id="fecha_redes_{{ r.id }}"
              />
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if r.confirmado_redes %}
              <span
                class="focus:outline-none text-white bg-{{ color }}-400 hover:bg-{{ color }}-500 focus:ring-4 focus:ring-{{ color }}-300 font-medium rounded-lg text-sm px-3 py-1 dark:focus:ring-{{ color }}-900"
              >
                Confirmado
              </span>
              {% else %}
              <button
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-1 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
                onclick="confirmarRedes('{{ r.id }}')"
              >
                Confirmar
              </button>
              {% endif %}
            </td>
            {% if sessionname == 'admin' or sessionname == 'verificador' %}
              <td class="px-4 py-2">
                {% if r.fecha_ingreso_cuenta %}
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 bg-{{ color }}-200 text-{{ color }}-800 rounded-lg shadow-sm font-bold"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                    />
                  </svg>
                  {{ r.fecha_ingreso_cuenta.strftime('%d-%m-%Y') }}
                </span>
                </span>
                {% else %}
                <input
                  type="date"
                  class="border border-gray-300 rounded px-3 py-2"
                  id="fecha_ingreso_cuenta_{{ r.id }}"
                />
                {% endif %}
              </td>
              <td class="px-4 py-2 text-center">
                {% if r.confirmado %}
                <span
                  class="focus:outline-none text-white bg-green-400 hover:bg-green-500 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-3 py-1 dark:focus:ring-green-900"
                  >Confirmado</span
                >
                {% else %}
                <button
                  class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-1 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
                  onclick="confirmarGerencia('{{ r.id }}')"
                >
                  Confirmar
                </button>
                {% endif %}
              </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <el-dialog>
    <dialog
      id="dialog-confirmar"
      aria-labelledby="dialog-title"
      class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent z-50"
    >
      <el-dialog-backdrop
        class="fixed inset-0 bg-gray-500/75 transition-opacity"
      ></el-dialog-backdrop>
      <div
        class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
      >
        <el-dialog-panel
          class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
        >
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div
                class="mx-auto flex size-12 shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:size-10"
              >
                <svg
                  class="size-6 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M13 16h-1v-4h-1m1-4h.01M12 18.5A6.5 6.5 0 105.5 12a6.5 6.5 0 006.5 6.5z"
                  />
                </svg>
              </div>
              <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                <h3
                  id="dialog-title"
                  class="text-base font-semibold text-gray-900"
                >
                  Confirmar transacción
                </h3>
                <p class="text-sm text-gray-600 mt-2">
                  ¿Estás seguro de confirmar esta transacción? Esta acción es
                  irreversible.
                </p>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
            <button
              type="button"
              id="btn-confirmar-modal"
              class="inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white hover:bg-green-500 sm:ml-3 sm:w-auto"
            >
              Confirmar
            </button>
            <button
              type="button"
              id="btn-cancelar-modal"
              command="close"
              commandfor="dialog-confirmar"
              class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs ring-1 ring-gray-300 ring-inset hover:bg-gray-50 sm:mt-0 sm:w-auto"
            >
              Cancelar
            </button>
          </div>
        </el-dialog-panel>
      </div>
    </dialog>
  </el-dialog>
  {% endblock %}
{% endif %}